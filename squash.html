import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged,
  signOut 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  getDocs, 
  updateDoc, 
  deleteDoc, 
  onSnapshot,
  query,
  where,
  Timestamp 
} from 'firebase/firestore';
import { 
  Users, 
  CheckCircle, 
  Trophy, 
  BookOpen, 
  DollarSign, 
  LogOut, 
  Plus, 
  Trash2, 
  Calendar,
  ChevronRight,
  ShieldCheck,
  Award
} from 'lucide-react';

// --- Firebase 配置 ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'squash-management-app';

// --- 主要組件 ---
export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('attendance');
  const [loading, setLoading] = useState(true);
  const [students, setStudents] = useState([]);
  const [logs, setLogs] = useState([]);
  const [attendanceRecords, setAttendanceRecords] = useState([]);

  // 1. 初始化身份驗證 (遵守 Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // 2. 獲取數據 (遵守 Rule 1 & 2)
  useEffect(() => {
    if (!user) return;

    const publicDataPath = ['artifacts', appId, 'public', 'data'];
    
    // 學生清單監聽
    const studentsUnsub = onSnapshot(
      collection(db, ...publicDataPath, 'students'),
      (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setStudents(data);
      },
      (err) => console.error("Students error:", err)
    );

    // 訓練日誌監聽
    const logsUnsub = onSnapshot(
      collection(db, ...publicDataPath, 'logs'),
      (snapshot) => {
        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setLogs(data.sort((a, b) => b.date?.seconds - a.date?.seconds));
      }
    );

    return () => {
      studentsUnsub();
      logsUnsub();
    };
  }, [user]);

  // --- 功能邏輯 ---
  const addStudent = async (name, level) => {
    if (!name) return;
    const studentRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'students'));
    await setDoc(studentRef, {
      name,
      level,
      points: 0,
      joinedAt: Timestamp.now()
    });
  };

  const markAttendance = async (studentId) => {
    const student = students.find(s => s.id === studentId);
    if (!student) return;
    const studentRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', studentId);
    await updateDoc(studentRef, {
      points: (student.points || 0) + 1
    });
  };

  // --- 子頁面組件 ---

  // A. 點名系統
  const AttendanceView = () => (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <CheckCircle className="text-green-500" /> 今日點名
        </h2>
        <span className="text-sm text-gray-500">{new Date().toLocaleDateString()}</span>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {students.map(student => (
          <div key={student.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
            <div>
              <p className="font-semibold text-lg">{student.name}</p>
              <p className="text-xs text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full inline-block">
                {student.level || '初級'}
              </p>
            </div>
            <button 
              onClick={() => markAttendance(student.id)}
              className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
            >
              簽到
            </button>
          </div>
        ))}
      </div>
    </div>
  );

  // B. 排行榜
  const LeaderboardView = () => {
    const sortedStudents = [...students].sort((a, b) => (b.points || 0) - (a.points || 0));
    return (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <Trophy className="text-yellow-500" /> 積分排行榜
        </h2>
        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-gray-50 border-b border-gray-100">
              <tr>
                <th className="px-6 py-4 font-semibold text-gray-600">排名</th>
                <th className="px-6 py-4 font-semibold text-gray-600">姓名</th>
                <th className="px-6 py-4 font-semibold text-gray-600">等級</th>
                <th className="px-6 py-4 font-semibold text-gray-600">總積分</th>
              </tr>
            </thead>
            <tbody>
              {sortedStudents.map((s, idx) => (
                <tr key={s.id} className="border-b border-gray-50 last:border-0 hover:bg-gray-50 transition-colors">
                  <td className="px-6 py-4">
                    {idx === 0 ? <Award className="text-yellow-500 w-5 h-5" /> : idx + 1}
                  </td>
                  <td className="px-6 py-4 font-medium">{s.name}</td>
                  <td className="px-6 py-4 text-sm text-gray-500">{s.level}</td>
                  <td className="px-6 py-4 font-bold text-blue-600">{s.points || 0}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  // C. 財務預算 (對應原本 Python 的計算邏輯)
  const FinanceView = () => {
    const [stats, setStats] = useState({
      studentsCount: 50,
      fee: 250,
      teamClasses: 1,
      trainClasses: 3,
      hobbyClasses: 4
    });

    const revenue = stats.studentsCount * stats.fee;
    const expenses = (stats.teamClasses * 2750) + (stats.trainClasses * 1350) + (stats.hobbyClasses * 1200);
    const profit = revenue - expenses;

    return (
      <div className="space-y-8">
        <h2 className="text-2xl font-bold flex items-center gap-2">
          <DollarSign className="text-emerald-500" /> 財務模擬預算
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-blue-50 p-6 rounded-2xl border border-blue-100">
            <p className="text-blue-600 text-sm font-medium">預計總收入</p>
            <p className="text-3xl font-bold text-blue-900">${revenue.toLocaleString()}</p>
          </div>
          <div className="bg-red-50 p-6 rounded-2xl border border-red-100">
            <p className="text-red-600 text-sm font-medium">預計總支出</p>
            <p className="text-3xl font-bold text-red-900">${expenses.toLocaleString()}</p>
          </div>
          <div className={`p-6 rounded-2xl border ${profit >= 0 ? 'bg-green-50 border-green-100' : 'bg-orange-50 border-orange-100'}`}>
            <p className={`${profit >= 0 ? 'text-green-600' : 'text-orange-600'} text-sm font-medium`}>預計盈餘</p>
            <p className={`text-3xl font-bold ${profit >= 0 ? 'text-green-900' : 'text-orange-900'}`}>${profit.toLocaleString()}</p>
          </div>
        </div>

        <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 space-y-6">
          <h3 className="text-lg font-semibold border-b pb-4 text-gray-700">參數調整</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div className="space-y-4">
              <label className="block">
                <span className="text-gray-600 text-sm mb-1 block">總人數</span>
                <input type="number" value={stats.studentsCount} onChange={e => setStats({...stats, studentsCount: +e.target.value})} className="w-full p-2 border rounded-lg" />
              </label>
              <label className="block">
                <span className="text-gray-600 text-sm mb-1 block">每人學費 ($)</span>
                <input type="number" value={stats.fee} onChange={e => setStats({...stats, fee: +e.target.value})} className="w-full p-2 border rounded-lg" />
              </label>
            </div>
            <div className="space-y-4">
              <label className="block text-sm">校隊班 ($2750/班): 
                <input type="number" value={stats.teamClasses} onChange={e => setStats({...stats, teamClasses: +e.target.value})} className="ml-2 w-20 p-1 border rounded" />
              </label>
              <label className="block text-sm">非校隊班 ($1350/班): 
                <input type="number" value={stats.trainClasses} onChange={e => setStats({...stats, trainClasses: +e.target.value})} className="ml-2 w-20 p-1 border rounded" />
              </label>
              <label className="block text-sm">簡易班 ($1200/班): 
                <input type="number" value={stats.hobbyClasses} onChange={e => setStats({...stats, hobbyClasses: +e.target.value})} className="ml-2 w-20 p-1 border rounded" />
              </label>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // --- 主佈局渲染 ---

  if (loading) {
    return <div className="h-screen flex items-center justify-center bg-gray-50">載入中...</div>;
  }

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row">
      {/* 側邊導航 */}
      <nav className="w-full md:w-64 bg-slate-900 text-white p-6 flex flex-col gap-8 shadow-xl">
        <div className="flex items-center gap-3 px-2">
          <div className="bg-blue-500 p-2 rounded-lg">
            <ShieldCheck className="w-6 h-6" />
          </div>
          <h1 className="text-xl font-bold tracking-tight">正覺壁球管理</h1>
        </div>

        <div className="flex flex-col gap-2 flex-1">
          <NavItem active={activeTab === 'attendance'} onClick={() => setActiveTab('attendance')} icon={<CheckCircle size={20}/>} label="今日點名" />
          <NavItem active={activeTab === 'leaderboard'} onClick={() => setActiveTab('leaderboard')} icon={<Trophy size={20}/>} label="積分排行" />
          <NavItem active={activeTab === 'finance'} onClick={() => setActiveTab('finance')} icon={<DollarSign size={20}/>} label="預算管理" />
          <NavItem active={activeTab === 'logs'} onClick={() => setActiveTab('logs')} icon={<BookOpen size={20}/>} label="訓練日誌" />
          <NavItem active={activeTab === 'settings'} onClick={() => setActiveTab('settings')} icon={<Users size={20}/>} label="學員管理" />
        </div>

        <div className="pt-4 border-t border-slate-800 text-xs text-slate-500 px-2">
          用戶ID: {user?.uid}
        </div>
      </nav>

      {/* 主內容區 */}
      <main className="flex-1 p-6 md:p-10 overflow-y-auto max-h-screen">
        <div className="max-w-5xl mx-auto">
          {activeTab === 'attendance' && <AttendanceView />}
          {activeTab === 'leaderboard' && <LeaderboardView />}
          {activeTab === 'finance' && <FinanceView />}
          
          {activeTab === 'settings' && (
             <div className="space-y-6">
                <h2 className="text-2xl font-bold flex items-center gap-2">學員管理</h2>
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex gap-4">
                  <input id="new-student-name" placeholder="學生姓名" className="flex-1 border rounded-lg px-4" />
                  <select id="new-student-level" className="border rounded-lg px-4">
                    <option>校隊</option>
                    <option>訓練班</option>
                    <option>簡易班</option>
                  </select>
                  <button 
                    onClick={() => {
                      const name = document.getElementById('new-student-name').value;
                      const level = document.getElementById('new-student-level').value;
                      addStudent(name, level);
                      document.getElementById('new-student-name').value = '';
                    }}
                    className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                  >
                    <Plus size={18} /> 新增
                  </button>
                </div>
                <div className="grid grid-cols-1 gap-4">
                  {students.map(s => (
                    <div key={s.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                      <span>{s.name} ({s.level})</span>
                      <button 
                        onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id))}
                        className="text-red-400 hover:text-red-600 p-2"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>
                  ))}
                </div>
             </div>
          )}

          {activeTab === 'logs' && (
            <div className="text-center py-20 text-gray-400">
              <BookOpen size={48} className="mx-auto mb-4 opacity-20" />
              <p>訓練日誌模組開發中...</p>
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

function NavItem({ active, onClick, icon, label }) {
  return (
    <button 
      onClick={onClick}
      className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${
        active 
        ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' 
        : 'text-slate-400 hover:bg-slate-800 hover:text-white'
      }`}
    >
      {icon}
      <span className="font-medium">{label}</span>
      {active && <ChevronRight size={16} className="ml-auto" />}
    </button>
  );
}
