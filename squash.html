<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­£è¦ºå£çƒç®¡ç†ç³»çµ± (SJ Squash)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-bold text-slate-500 tracking-widest">ç³»çµ±è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-700 to-indigo-900 p-4 hidden">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-full max-w-md transform transition-all hover:scale-[1.01]">
            <div class="flex justify-center mb-6">
                <div class="bg-blue-100 p-5 rounded-3xl text-blue-600">
                    <i class="fas fa-table-tennis-paddle-ball fa-3x"></i>
                </div>
            </div>
            <h1 class="text-2xl font-black text-center mb-2">SJ SQUASH</h1>
            <p class="text-slate-400 text-center text-sm mb-8">æ­£è¦ºå£çƒæ ¡éšŠç®¡ç†ç³»çµ±</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">èº«ä»½ / å­¸ç”Ÿ ID</label>
                    <input id="login-id" type="text" placeholder="ä¾‹å¦‚: 1A01" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 ring-blue-500 transition">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">ç®¡ç†å“¡å¯†ç¢¼ (å¯è·³é)</label>
                    <input id="login-pwd" type="password" placeholder="ç®¡ç†å“¡å°ˆç”¨" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 ring-blue-500 transition">
                </div>
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 active:scale-95 transition">
                    é€²å…¥ç³»çµ±
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="hidden">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-40 px-4 h-16 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-2">
                <i class="fas fa-trophy text-blue-600 text-xl"></i>
                <span class="font-black text-xl tracking-tighter">SJ SQUASH</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="user-badge" class="text-xs font-bold bg-slate-100 px-3 py-1.5 rounded-full text-slate-600">USER</span>
                <button onclick="location.reload()" class="p-2 text-slate-300 hover:text-red-500 transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-100 sticky top-16 z-30 overflow-x-auto no-scrollbar">
            <div class="flex px-4 max-w-4xl mx-auto">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-6 py-4 font-bold text-sm whitespace-nowrap tab-active">è¨“ç·´æ—¥ç¨‹</button>
                <button onclick="switchTab('ranking')" id="tab-ranking" class="px-6 py-4 font-bold text-sm whitespace-nowrap text-slate-400">ç©åˆ†æ’è¡Œ</button>
                <button onclick="switchTab('awards')" id="tab-awards" class="px-6 py-4 font-bold text-sm whitespace-nowrap text-slate-400">æ¦®è­½å‹³ç« </button>
                <button onclick="switchTab('admin')" id="tab-admin" class="px-6 py-4 font-bold text-sm whitespace-nowrap text-slate-400 hidden">è²¡å‹™ç®¡ç†</button>
            </div>
        </nav>

        <main class="p-4 md:p-8 max-w-5xl mx-auto">
            <!-- Dashboard View -->
            <section id="view-dashboard" class="space-y-6">
                <div class="flex justify-between items-end">
                    <h2 class="text-2xl font-black">ğŸ“… è¨“ç·´æ—¥ç¨‹</h2>
                    <p class="text-xs text-slate-400 font-bold" id="current-date"></p>
                </div>
                <div id="schedule-list" class="grid gap-4">
                    <!-- Schedule items injected here -->
                </div>
            </section>

            <!-- Ranking View -->
            <section id="view-ranking" class="hidden space-y-6">
                <h2 class="text-2xl font-black">ğŸ† ç©åˆ†æ’è¡Œ</h2>
                <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                    <div id="ranking-list" class="divide-y divide-slate-100">
                        <!-- Ranking items injected here -->
                    </div>
                </div>
            </section>

            <!-- Awards View -->
            <section id="view-awards" class="hidden space-y-6">
                <h2 class="text-2xl font-black">ğŸ–ï¸ æ¦®è­½å‹³ç« </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ’</div>
                        <div class="font-bold text-blue-600">ç™½é‡‘ç« </div>
                        <div class="text-[10px] text-slate-400 uppercase mt-1">æœ€é«˜æ¦®è­½</div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ¥‡</div>
                        <div class="font-bold text-yellow-600">é‡‘ç« </div>
                        <div class="text-[10px] text-slate-400 uppercase mt-1">é€²éšæ°´æº–</div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ¥ˆ</div>
                        <div class="font-bold text-slate-400">éŠ€ç« </div>
                        <div class="text-[10px] text-slate-400 uppercase mt-1">ä¸­ç´šæ°´å¹³</div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-100 text-center shadow-sm">
                        <div class="text-4xl mb-2">ğŸ¥‰</div>
                        <div class="font-bold text-amber-700">éŠ…ç« </div>
                        <div class="text-[10px] text-slate-400 uppercase mt-1">åŸºç¤å…¥é–€</div>
                    </div>
                </div>
            </section>

            <!-- Admin Financial View -->
            <section id="view-admin" class="hidden space-y-6">
                <h2 class="text-2xl font-black">ğŸ’° è²¡å‹™åˆ†æ (ç®¡ç†å“¡)</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-blue-600 p-6 rounded-3xl text-white">
                        <p class="text-xs font-bold opacity-70 mb-1">é è¨ˆç¸½æ”¶å…¥</p>
                        <p class="text-3xl font-black" id="stat-revenue">$0</p>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-3xl text-white">
                        <p class="text-xs font-bold opacity-70 mb-1">é è¨ˆç¸½é–‹æ”¯</p>
                        <p class="text-3xl font-black" id="stat-expense">$0</p>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border border-slate-200">
                        <p class="text-xs font-bold text-slate-400 mb-1">é è¨ˆç›ˆé¤˜</p>
                        <p class="text-3xl font-black text-green-600" id="stat-profit">$0</p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-3xl border border-slate-200">
                    <h3 class="font-bold mb-4">é–‹ç­è²»è¨ˆç®—è¨­å®š</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400">å­¸ç”Ÿäººæ•¸</label>
                                <input type="number" id="input-students" value="50" oninput="calcAdmin()" class="w-full bg-slate-50 border-none rounded-xl p-3 mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400">æ¯äººå­¸è²» ($)</label>
                                <input type="number" id="input-fee" value="250" oninput="calcAdmin()" class="w-full bg-slate-50 border-none rounded-xl p-3 mt-1">
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center text-sm p-3 bg-slate-50 rounded-xl">
                                <span>æ ¡éšŠç­ (x1)</span>
                                <span class="font-bold">$2,750</span>
                            </div>
                            <div class="flex justify-between items-center text-sm p-3 bg-slate-50 rounded-xl">
                                <span>éæ ¡éšŠç­ (x3)</span>
                                <span class="font-bold">$4,050</span>
                            </div>
                            <div class="flex justify-between items-center text-sm p-3 bg-slate-50 rounded-xl">
                                <span>ç°¡æ˜“ç­ (x4)</span>
                                <span class="font-bold">$4,800</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ– Firebase (ä½¿ç”¨å…¨åŸŸè®Šæ•¸) ---
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: ""
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'squash-management-v1';

        let currentUser = null;
        let isAdmin = false;

        // --- 2. èªè­‰è™•ç† ---
        window.onload = async () => {
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric' });
            
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (e) { console.error("Auth failed", e); }

            auth.onAuthStateChanged(user => {
                currentUser = user;
                document.getElementById('loader').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('login-screen').classList.remove('hidden');
                }, 500);
            });
        };

        function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pwd = document.getElementById('login-pwd').value.trim();

            if (!id) return alert("è«‹è¼¸å…¥ ID æˆ–å§“å");

            if (pwd === "8888") {
                isAdmin = true;
                document.getElementById('tab-admin').classList.remove('hidden');
                document.getElementById('user-badge').innerText = "ğŸ›¡ï¸ ç®¡ç†å“¡";
            } else {
                document.getElementById('user-badge').innerText = `ğŸ‘¤ ${id}`;
            }

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            // è¼‰å…¥æ•¸æ“š
            initDataListeners();
            calcAdmin();
        }

        // --- 3. æ•¸æ“šåŒæ­¥ (Real-time) ---
        function initDataListeners() {
            if (!currentUser) return;

            // ç›£è½æ’è¡Œæ¦œ
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rankings')
                .onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderRanking(data);
                }, err => console.error("Ranking Fetch Error", err));

            // ç›£è½æ—¥ç¨‹
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('schedules')
                .onSnapshot(snapshot => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSchedule(data);
                });
        }

        // --- 4. æ¸²æŸ“é‚è¼¯ ---
        function renderSchedule(data) {
            const list = document.getElementById('schedule-list');
            if (data.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-400 italic">æš«ç„¡è¨“ç·´å®‰æ’...</div>`;
                return;
            }
            list.innerHTML = data.map(s => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-600">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div>
                            <p class="font-black text-lg text-slate-800">${s.ç­ç´š || 'å£çƒè¨“ç·´ç­'}</p>
                            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">${s.æ—¥æœŸ || '--'} | ${s.æ™‚é–“ || '--'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-full text-slate-500">
                            ğŸ“ ${s.åœ°é» || 'å¾…å®š'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderRanking(data) {
            const list = document.getElementById('ranking-list');
            const sorted = data.sort((a, b) => (b.ç©åˆ† || 0) - (a.ç©åˆ† || 0));
            
            list.innerHTML = sorted.map((p, idx) => `
                <div class="flex items-center gap-4 p-4 hover:bg-slate-50 transition">
                    <div class="w-8 h-8 flex items-center justify-center rounded-full font-black text-sm ${idx < 3 ? 'bg-blue-600 text-white' : 'text-slate-300'}">
                        ${idx + 1}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold flex items-center gap-2">
                            ${p.å§“å || 'åŒ¿å'} 
                            ${p.ç« åˆ¥ ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-600 font-black">${p.ç« åˆ¥}</span>` : ''}
                        </div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${p.ç­ç´š || '--'}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black text-blue-700 leading-none">${p.ç©åˆ† || 0}</div>
                        <div class="text-[9px] text-slate-300 font-bold uppercase tracking-tighter">Points</div>
                    </div>
                </div>
            `).join('');
        }

        // --- 5. å°è¦½é‚è¼¯ ---
        function switchTab(tab) {
            ['dashboard', 'ranking', 'awards', 'admin'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const view = document.getElementById(`view-${t}`);
                if (btn) btn.classList.remove('tab-active', 'text-slate-400');
                if (view) view.classList.add('hidden');
                
                if (t !== tab && btn) btn.classList.add('text-slate-400');
            });
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

        // --- 6. è²¡å‹™è¨ˆç®—é‚è¼¯ ---
        function calcAdmin() {
            const students = parseInt(document.getElementById('input-students').value) || 0;
            const fee = parseInt(document.getElementById('input-fee').value) || 0;
            
            const revenue = students * fee;
            const expense = 2750 + 4050 + 4800; // æ ¹æ“šæ‚¨ Python æª”æ¡ˆä¸­çš„é è¨­å€¼
            const profit = revenue - expense;

            document.getElementById('stat-revenue').innerText = `$${revenue.toLocaleString()}`;
            document.getElementById('stat-expense').innerText = `$${expense.toLocaleString()}`;
            document.getElementById('stat-profit').innerText = `$${profit.toLocaleString()}`;
            document.getElementById('stat-profit').className = `text-3xl font-black ${profit >= 0 ? 'text-green-600' : 'text-red-500'}`;
        }
    </script>
</body>
</html>

export default App;

